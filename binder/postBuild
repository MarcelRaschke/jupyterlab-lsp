#!/usr/bin/env bash
set -eux

# Avoid OpenSSL error when Node.js > 16
# https://stackoverflow.com/questions/73144960
nodeversion="$(node -v | cut -d 'v' -f 2 | cut -d '.' -f 1)"
if (( "$nodeversion" > 16 ))
then
    export NODE_OPTIONS="--openssl-legacy-provider"
fi

# Build labextensions
jlpm bootstrap

# Do a dev install of the server side
pushd python_packages/jupyter_lsp
    python setup.py sdist bdist_wheel
    python -m pip install -e . --ignore-installed --no-deps -vv
    jupyter serverextension enable --sys-prefix --py jupyter_lsp
popd

# Install the labextension
pushd python_packages/jupyterlab_lsp
    python setup.py sdist bdist_wheel
    python -m pip install -e . --ignore-installed --no-deps -vv
    jupyter labextension develop . --overwrite
popd

# List extensions
jupyter serverextension list
jupyter server extension list
jupyter labextension list

if [ "$NB_USER" = "jovyan" ]; then
    mkdir -p $NB_PYTHON_PREFIX/share/jupyter/lab/settings/
    cp binder/overrides.json $NB_PYTHON_PREFIX/share/jupyter/lab/settings/
fi
